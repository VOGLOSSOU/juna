// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  PROVIDER
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  IN_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethod {
  MOBILE_MONEY_WAVE
  MOBILE_MONEY_MTN
  MOBILE_MONEY_MOOV
  MOBILE_MONEY_ORANGE
  CARD
  CASH
}

enum DeliveryMethod {
  DELIVERY
  PICKUP
}

enum SubscriptionFrequency {
  DAILY
  THREE_PER_WEEK
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum SubscriptionType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  BREAKFAST_LUNCH
  BREAKFAST_DINNER
  LUNCH_DINNER
  FULL_DAY
  CUSTOM
}

enum SubscriptionCategory {
  AFRICAN
  EUROPEAN
  ASIAN
  AMERICAN
  FUSION
  VEGETARIAN
  VEGAN
  HALAL
  OTHER
}

enum ProposalStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProviderStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ESCALATED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  PAYMENT
  DELIVERY
  QUALITY
  TECHNICAL
  ACCOUNT
  OTHER
}

enum NotificationType {
  ORDER_CONFIRMATION
  ORDER_PREPARING
  ORDER_READY
  ORDER_DELIVERED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  PROPOSAL_VALIDATED
  PROPOSAL_REJECTED
  REVIEW_PUBLISHED
  TICKET_RESPONSE
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_RENEWED
  REFERRAL_REWARD
  SYSTEM
}

enum ReferralStatus {
  PENDING
  COMPLETED
  EXPIRED
}

// ============================================
// MODELS
// ============================================

model User {
  id            String        @id @default(uuid()) @db.Uuid
  email         String        @unique
  password      String
  name          String
  phone         String?       @unique
  role          UserRole      @default(USER)
  isVerified    Boolean       @default(false)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  profile       UserProfile?
  provider      Provider?
  admin         Admin?
  orders        Order[]
  payments      Payment[]
  proposals     CustomProposal[]
  reviews       Review[]
  tickets       SupportTicket[]
  notifications Notification[]
  refreshTokens RefreshToken[]
  referrals     Referral[]     @relation("Referrer")
  referredBy    Referral[]     @relation("Referee")
  ticketMessages TicketMessage[]

  @@index([email])
  @@index([phone])
  @@map("users")
}

model UserProfile {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @unique @db.Uuid
  avatar      String?
  address     String?
  latitude    Float?
  longitude   Float?
  city        String?
  country     String?
  preferences Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Provider {
  id              String          @id @default(uuid()) @db.Uuid
  userId          String          @unique @db.Uuid
  businessName    String
  description     String?         @db.Text
  businessAddress String
  documentUrl     String?
  status          ProviderStatus  @default(PENDING)
  rating          Float           @default(0)
  totalReviews    Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions   Subscription[]
  meals           Meal[]

  @@index([status])
  @@map("providers")
}

model Meal {
  id          String    @id @default(uuid()) @db.Uuid
  providerId  String    @db.Uuid
  name        String
  description String    @db.Text
  price       Float
  imageUrl    String?
  mealType    MealType
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  provider    Provider              @relation(fields: [providerId], references: [id], onDelete: Cascade)
  mealsInSubscriptions SubscriptionMeal[]

  @@index([providerId])
  @@index([mealType])
  @@map("meals")
}

model Subscription {
  id               String             @id @default(uuid()) @db.Uuid
  providerId       String             @db.Uuid
  name             String
  description      String             @db.Text
  price           Float
  type             SubscriptionType
  category         SubscriptionCategory
  frequency        SubscriptionFrequency
  isActive         Boolean            @default(true)
  isPublic         Boolean            @default(true)
  deliveryZones    Json?
  pickupLocations  Json?
  imageUrl         String?
  subscriberCount  Int                @default(0)
  rating           Float              @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  // Relations
  provider         Provider                @relation(fields: [providerId], references: [id], onDelete: Cascade)
  orders           Order[]
  reviews          Review[]
  proposals        CustomProposal[]
  mealsInSubscriptions SubscriptionMeal[]

  @@index([providerId])
  @@index([type])
  @@index([category])
  @@index([frequency])
  @@index([isActive])
  @@index([isPublic])
  @@map("subscriptions")
}

model SubscriptionMeal {
  id             String      @id @default(uuid()) @db.Uuid
  subscriptionId String      @db.Uuid
  mealId         String      @db.Uuid
  quantity       Int         @default(1)

  // Relations
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  meal           Meal        @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, mealId])
  @@map("subscription_meals")
}

model Order {
  id              String          @id @default(uuid()) @db.Uuid
  userId          String          @db.Uuid
  subscriptionId  String          @db.Uuid
  orderNumber     String          @unique
  amount          Float
  status          OrderStatus     @default(PENDING)
  deliveryMethod  DeliveryMethod
  deliveryAddress String?
  pickupLocation  String?
  scheduledFor    DateTime?
  completedAt     DateTime?
  qrCode          String?         @unique
  metadata        Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  user            User            @relation(fields: [userId], references: [id])
  subscription    Subscription    @relation(fields: [subscriptionId], references: [id])
  payment         Payment?
  review          Review?
  tickets         SupportTicket[]

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

model Payment {
  id              String        @id @default(uuid()) @db.Uuid
  orderId         String        @unique @db.Uuid
  userId          String        @db.Uuid
  amount          Float
  currency        String        @default("XOF")
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  transactionId   String?       @unique
  gatewayResponse Json?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

model CustomProposal {
  id                    String         @id @default(uuid()) @db.Uuid
  userId                String         @db.Uuid
  foodType              String
  frequency             String
  mealType              MealType
  budget                Float
  zone                  String
  city                  String
  country               String
  details               String?        @db.Text
  isPublic              Boolean        @default(false)
  status                ProposalStatus @default(PENDING)
  rejectionReason       String?        @db.Text
  assignedSubscriptionId String?       @unique @db.Uuid
  validatedAt           DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // Relations
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription          Subscription?  @relation(fields: [assignedSubscriptionId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("custom_proposals")
}

model Review {
  id              String       @id @default(uuid()) @db.Uuid
  userId          String       @db.Uuid
  subscriptionId  String       @db.Uuid
  orderId         String       @unique @db.Uuid
  rating          Int
  comment         String?      @db.Text
  status          ReviewStatus @default(PENDING)
  moderatedAt     DateTime?
  moderatedBy     String?      @db.Uuid
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  order           Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@map("reviews")
}

model SupportTicket {
  id          String          @id @default(uuid()) @db.Uuid
  userId      String          @db.Uuid
  orderId     String?         @db.Uuid
  category    TicketCategory
  subject     String
  description String          @db.Text
  status      TicketStatus    @default(OPEN)
  priority    TicketPriority  @default(MEDIUM)
  assignedTo  String?         @db.Uuid
  resolvedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  order       Order?          @relation(fields: [orderId], references: [id])
  messages    TicketMessage[]

  @@index([userId])
  @@index([status])
  @@index([category])
  @@map("support_tickets")
}

model TicketMessage {
  id          String        @id @default(uuid()) @db.Uuid
  ticketId    String        @db.Uuid
  senderId    String        @db.Uuid
  message     String        @db.Text
  attachments Json?
  createdAt   DateTime      @default(now())

  // Relations
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender      User          @relation(fields: [senderId], references: [id])

  @@index([ticketId])
  @@map("ticket_messages")
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @db.Uuid
  type      NotificationType
  title     String
  message   String           @db.Text
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique  @db.Text
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Referral {
  id            String         @id @default(uuid()) @db.Uuid
  referrerId    String         @db.Uuid
  refereeId     String?        @db.Uuid
  code          String         @unique
  status        ReferralStatus @default(PENDING)
  rewardAmount  Float          @default(0)
  completedAt   DateTime?
  createdAt     DateTime       @default(now())

  // Relations
  referrer      User           @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee       User?          @relation("Referee", fields: [refereeId], references: [id])

  @@index([referrerId])
  @@index([code])
  @@map("referrals")
}

model Admin {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @unique @db.Uuid
  permissions Json?
  level       String   @default("ADMIN")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

// ============================================
// TABLES SUPPLÉMENTAIRES (Optionnelles v2)
// ============================================

// Table pour logs d'activité admin
model AdminLog {
  id        String   @id @default(uuid()) @db.Uuid
  adminId   String   @db.Uuid
  action    String
  targetId  String?  @db.Uuid
  details   Json?
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@map("admin_logs")
}

// Table pour analytics
model Analytics {
  id        String   @id @default(uuid()) @db.Uuid
  date      DateTime
  metric    String
  value     Float
  metadata  Json?
  createdAt DateTime @default(now())

  @@unique([date, metric])
  @@index([date])
  @@index([metric])
  @@map("analytics")
}
